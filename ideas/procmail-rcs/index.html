<!DOCTYPE html>

<html lang="en" dir="ltr">
	<head>
		<title>
			Procmail and RCS - Stereochrome
		</title>

		<meta name="Author" content="Keith Gaughan">
		<meta name="Copyright" content="Copyright (c) Keith Gaughan, 2001-2019">

		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" media="screen" href="/assets/screen.css"><link rel="stylesheet" type="text/css" media="print" href="/assets/print.css">
<link rel="stylesheet" type="text/css" media="screen" href="/assets/prettify.css">

		<style type="text/css" media="handheld">
		#content, #footer, #masthead {
			width: 22em;
			font-size: 200%;
		}
		</style>
	</head>
	<body>
		<div id="masthead"><a href="/">stereochro<span>me</span></a></div>
		<div id="outer1">
			<div id="content">
				
		<h1>Procmail and RCS</h1>

	<p>A few quick notes on using procmail and RCS together.</p>

<h2>RCS</h2>

<p>Always ensure the directory contains an <code>RCS</code> directory for RCS to store its data. Only two commands are really needed:</p>

<pre class="prettyprint"><code>rcsdiff -u .procmailrc
ci -l .procmailrc
</code></pre>

<p>The former shows a unified diff of the changes. The latter checks in the current changes and immediately relocks the file (thus ensuring a copy always exists for procmail and for editing on the disc. <code>rlog</code> is useful for dumping the revision history if you don&#8217;t use <code>$Log</code> to embed the history in the version-controlled file itself.</p>

<h2>Procmail</h2>

<p>It&#8217;s a good idea to put your rules in the following order:</p>

<ul>
<li>Rule to send mail to /dev/null</li>
<li>Duplicate filtering</li>
<li>TNEF attachment filtering</li>
<li>Mailing lists</li>
<li>Notifications</li>
<li>Other rules</li>
</ul>

<p>That helps minimise the amount of processing needed.</p>

<h2>Logging</h2>

<p>I set up my logfile in <code>.procmailrc</code> as follows:</p>

<pre class="prettyprint"><code>LOGFILE=$HOME/logs/procmail.`date +%Y%m`.log
</code></pre>

<p>That ensures a separate logfile is generated for each month and that the ordering is safe. To compress those logs at the start of the following month, I have this in my crontab:</p>

<pre class="prettyprint"><code>0 0 1 * * for i in `ls $HOME/logs/procmail.*.log | sort -r | tail -n +2`; do gzip $i; done
</code></pre>

<p>The loop is there just in case nothing needs compressing. However, there&#8217;ll usually only be the one logfile to compress.</p>

<h3>Duplicate filtering</h3>

<p>This rule uses formail to remove emails that have a message-id that has already passed through the system. It keeps an 8K log. &#8220;W&#8221; waits until it gets the exit code from formail and filters if appropriate. the &#8216;h&#8217; means pipe the headers only. it uses a user-defined lockfile for this task.</p>

<pre class="prettyprint"><code>:0 Wh: msgid.lock
| /usr/bin/formail -D 8192 $HOME/.msgid.cache
</code></pre>

<h3>TNEF attachments</h3>

<p>Dealing with people who wouldn&#8217;t know a grown-up mail server and mail agent if it hit them in the face? <a href="http://sourceforge.net/projects/ytnef/">ytnef</a> to the rescue!</p>

<pre class="prettyprint"><code>:0
* ^X-MS-TNEF-Correlator
{
    :0 fw B
    * winmail.dat
    | /usr/bin/ytnef-filter
}
</code></pre>

<h3>Filtering</h3>

<p><em>to do</em></p>

<h2>Links</h2>

<ul>
<li><a href="http://lipas.uwasa.fi/~ts/info/proctips.html">procmail tips and recipes</a></li>
</ul>

	<div id="metadata">
		Created at 15:14 UTC on May 22nd, 2012					and last modified at 16:11 UTC on May 22nd, 2012			</div>
				</div>
		</div>
		<div id="outer2">
			<div id="footer">
				<hr>
				<a href="http://en.wikipedia.org/wiki/Hacker_(programmer_subculture)"><img src="/assets/images/glider.png" style="float:right" width="55" height="55" alt="Hacker"></a>
								<ul id="nav">
					<li><a href="/">Home</a></li>
					<li><a href="/about">About</a></li>
					<li><a href="/weblog/">Weblog</a></li>
					<li><a href="/projects">Projects</a></li>
					<li><a href="/colophon">Colophon</a></li>
					<li><a href="/sitemap">Sitemap</a></li>
				</ul>
				<address>
					Copyright &copy; Keith Gaughan, 2001&#8210;2019.
					All Rights Reserved.
					You can stop reading now.
				</address>
				<p>
<a href="//ipv6ready.ie/verify/d64e5fedaefdb41b1a0b198d4a4faa7a3cf832de">
  <img width="120" height="20"
	src="//d-badges.ipv6ready.ie/d/64/e5/fe/d64e5fedaefdb41b1a0b198d4a4faa7a3cf832de-s.png"
	alt="[IPv6 Ready]">
</a>
				</p>
			</div>
		</div>
		<script type="text/javascript" src="/assets/prettify.js"></script>
<script type="text/javascript">prettyPrint();</script>			</body>
</html>
