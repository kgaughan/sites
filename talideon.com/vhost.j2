map $uri $talideon_new_path {
	/Getting%20Ubuntu%20running%20on%20a%20Lenovo%20Miix%20310 /getting-ubuntu-up-and-running-on-a-lenovo-miix-310.html;
	/ubuntu-lenovo-miix-310/ /getting-ubuntu-up-and-running-on-a-lenovo-miix-310.html;
	/about/ /about/;
	/about/contact/ /about/;
	/concultures/ /conlanging/;
	/concultures/ananagyu/ /conlanging/ananagyu/;
	/concultures/ananagyu/nouns.cfm /conlanging/ananagyu/;
	/concultures/porteressia/ /conlanging/porteressia/;
	/downloads/gridbag.pdf /attachments/gridbag.pdf;
	/downloads/hackers-diet/ladder.pdf /attachments/hackers-diet/ladder.pdf;
	/downloads/hackers-diet/log.pdf /attachments/hackers-diet/log.pdf;
	/feed/ /feeds/all.xml;
	/rss.xml /feeds/all.xml;
}

server {
	include common_params;
	include ssl_params;

	server_name {{ domain_name }};
	root {{ vhosts_root }}/{{ domain_name }}/web;
	index index.php index.html index.htm;

	location /inklings/ {
		proxy_pass http://127.0.0.1:8000/;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}

	location /inklings/static/ {
		alias {{ vhosts_root }}/{{ domain_name }}/inklings/komorebi/static/;
	}

	location = "/code/qbal/spec/" { return 301 https://mirrors.talideon.com/articles/qbal/; }
	location = "/downloads/star-w.pdf" { return 301 https://mirrors.talideon.com/articles/star-w.pdf; }
	location = "/inklings/%3bfeed" { return 301 https://{{ domain_name }}/inklings/feed; }
	location = "/inklings/;feed" { return 301 https://{{ domain_name }}/inklings/feed; }
	location = "/linklog/" { return 301 https://{{ domain_name }}/inklings/; }
	location = "/linklog/syndication.cfm" { return 301 https://{{ domain_name }}/inklings/feed; }
	location = "/notes/" { return 301 https://stereochro.me/projects/dcom3notes; }
	location = "/projects/elementnode/" { return 301 https://github.com/kgaughan/elementnode; }
	location = "/projects/qbal/" { return 301 https://mirrors.talideon.com/articles/qbal/; }
	location = "/reader/" { return 301 https://reader.talideon.com/; }
	location = "/weblog/" { return 301 https://{{ domain_name }}/inklings/; }
	location = "/weblog/syndication.cfm" { return 301 https://{{ domain_name }}/inklings/feed; }
	location ~ "/notes/dcom3/(.*)" { return 301 https://stereochro.me/assets/uploads/notes/dcom3/$1; }

	rewrite "^/weblog/\d{4}/\d\d/([^.]+)\.cfm$" "https://i.canthack.it/$1.html" permanent;

	if ($talideon_new_path) {
		return 301 https://i.canthack.it$talideon_new_path;
	}

	add_header Content-Security-Policy "default-src 'self'; script-src https://*.talideon.com https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval' 'self'; style-src https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline' 'self'; font-src https://fonts.gstatic.com 'self'; object-src https://*.talideon.com https://www.youtube-nocookie.com" always;

	ssl_certificate {{ tls_root }}/{{ domain_name }}/fullchain.pem;
	ssl_certificate_key {{ tls_root }}/private/{{ domain_name }}.pem;

	access_log {{ logs_root }}/{{ domain_name }}.access.log combined;
	error_log {{ logs_root }}/{{ domain_name }}.error.log;
}

server {
	include common_params;
	include ssl_params;

	server_name www.{{ domain_name }};
	return 301 https://{{ domain_name }}$request_uri;

	ssl_certificate {{ tls_root }}/{{ domain_name }}/fullchain.pem;
	ssl_certificate_key {{ tls_root }}/private/{{ domain_name }}.pem;
}

server {
	include common_params;

	listen 80;
	listen [::]:80;

	server_name .{{ domain_name }};
	return 301 https://$host$request_uri;
}
